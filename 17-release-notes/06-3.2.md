# MongoDB 3.2的发布说明

*2015年12月8日*

MongoDB 3.2现已推出。主要功能包括作为默认存储引擎的WiredTiger、复制选择增强、将服务器配置为副本集、`readConcern`和文档验证。

OpsManager 2.0也可用。请参阅[OpsManager文档](http://docs.opsmanager.mongodb.com/current/)和[OpsManager发布说明](http://docs.opsmanager.mongodb.com/current/release-notes/application/)了解更多信息。

### 默认情况下，WiredTiger

从3.2开始，MongoDB使用WiredTiger作为默认存储引擎。

要指定MMAPv1存储引擎，您必须指定存储引擎设置：

- 在带有`--storageEngine`选项的命令行上：

```shell
mongod --storageEngine mmapv1
```

* 或者在[配置文件](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#std-label-configuration-options)中使用[`storage.engine`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-storage.engine)设置：

```shell
storage:
   engine: mmapv1
```

> 笔记：
>
> 对于现有部署，如果您没有指定`--storageEngine`或[`storage.engine`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-storage.engine)设置，MongoDB 3.2可以自动确定用于在`--dbpath`或[`storage.dbPath`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-storage.dbPath)中创建数据文件的存储引擎[。](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-storage.dbPath)
>
> 如果指定`--storageEngine`或[`storage.engine`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-storage.engine)，如果`dbPath`包含由指定的存储引擎以外的存储引擎创建的数据文件，则[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)将不会启动。

> 另见：
>
> [默认存储引擎更改](https://www.mongodb.com/docs/upcoming/release-notes/3.2-compatibility/#std-label-3.2-storage-engine-compatibility)

#### WiredTiger默认缓存大小

从MongoDB 3.2开始，默认情况下，WiredTiger内部缓存将使用较大的缓存：

- 60%的RAM减去1 GB，或
- 1 GB。

有关更多信息，请参阅[WiredTiger和内存使用。](https://www.mongodb.com/docs/upcoming/core/wiredtiger/#std-label-wiredtiger-RAM)

#### WiredTiger日志写入频率

MongoDB 3.2将WiredTiger配置为每50毫秒写入日志文件。这是对现有日记撰写间隔和条件的补充。有关更多信息，请参阅[日志流程。](https://www.mongodb.com/docs/upcoming/core/journaling/#std-label-journal-process)

### 复制选举增强功能

从MongoDB 3.2开始，MongoDB减少了副本集的故障转移时间，并加快了对多个同时初选的检测。

作为此增强的一部分，MongoDB引入了该协议的第1版。默认情况下，新的副本集将使用[`protocolVersion: 1`](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.protocolVersion)以前版本的MongoDB使用协议的版本0。

此外，MongoDB引入了一个新的[副本集配置](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/)选项[`electionTimeoutMillis`](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.settings.electionTimeoutMillis)。[`electionTimeoutMillis`](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.settings.electionTimeoutMillis)指定了检测副本集主选项何时无法到达的时间限制（以毫秒为单位）。

[`electionTimeoutMillis`](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.settings.electionTimeoutMillis)仅在使用其[`replication protocol`](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.protocolVersion)版本1时适用[。](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.protocolVersion)

> 另见：
>
> [复制集协议版本](https://www.mongodb.com/docs/upcoming/reference/replica-set-protocol-versions/)

### 分片集群增强功能

MongoDB 3.2不建议在配置服务器上使用三个镜像[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)实例。

相反，从3.2开始，分片集群的[配置服务器](https://www.mongodb.com/docs/upcoming/core/sharded-cluster-config-servers/#std-label-sharding-config-server)可以部署为副本集。副本集配置服务器必须运行WiredTiger存储引擎。

这一变化提高了配置服务器的一致性，因为MongoDB可以利用标准副本集读取和写入协议来分片配置数据。此外，这允许分片集群拥有超过3台配置服务器，因为副本集最多可以有50个成员。

有关更多信息，请参阅[配置服务器](https://www.mongodb.com/docs/upcoming/core/sharded-cluster-config-servers/#std-label-sharding-config-server)。要部署带有副本集配置服务器**的新**分片集群，请参阅[部署分片集群。](https://www.mongodb.com/docs/upcoming/tutorial/deploy-shard-cluster/)

MongoDB 3.2不建议对分片集群的组件使用主从复制。

从3.2开始，[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)在启动期间将继续尝试联系配置服务器，直到可用。在之前的版本中，如果[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)找不到配置服务器，它将在启动期间关闭。

#### `readConcern`

MongoDB 3.2为副本集和副本集碎片引入了`readConcern`查询选项。对于[WiredTiger存储引擎](https://www.mongodb.com/docs/upcoming/core/wiredtiger/)，`readConcern`选项允许客户端为其读取选择一定程度的隔离。您可以指定一个`"majority"`的`readConcern`来读取已写入大多数节点的数据，因此无法回滚。默认情况下，MongoDB使用`"local"`的`readConcern`返回查询时节点可用的最新数据，即使数据没有保留到大多数节点，并且可能会回滚。与[MMAPv1存储引擎](https://www.mongodb.com/docs/v3.2/core/mmapv1/)，您只能指定`"local"`的aindConcern`readConcern`

`readConcern`需要为MongoDB 3.2更新MongoDB驱动程序。

有关`readConcern`的详细信息，包括支持该选项的操作，请参阅[阅读关注。](https://www.mongodb.com/docs/upcoming/reference/read-concern/)

### 部分索引

MongoDB 3.2提供了创建索引的选项，该索引仅索引满足指定过滤器表达式的集合中的文档。通过对集合中的文档子集进行索引，部分索引降低了存储要求，并降低了索引创建和维护的性能成本。您可以为所有MongoDB[索引类型](https://www.mongodb.com/docs/upcoming/indexes/#std-label-index-types)指定partialFilterExpression选项[。](https://www.mongodb.com/docs/upcoming/indexes/#std-label-index-types)

`partialFilterExpression`选项接受使用以下方式指定条件的文档：

- 相等表达式（即`field: value`或使用[`$eq`](https://www.mongodb.com/docs/upcoming/reference/operator/query/eq/#mongodb-query-op.-eq)运算符），
- [`$exists: true`](https://www.mongodb.com/docs/upcoming/reference/operator/query/exists/#mongodb-query-op.-exists)表达，
- [`$gt`](https://www.mongodb.com/docs/upcoming/reference/operator/query/gt/#mongodb-query-op.-gt)，[`$gte`](https://www.mongodb.com/docs/upcoming/reference/operator/query/gte/#mongodb-query-op.-gte)，[`$lt`](https://www.mongodb.com/docs/upcoming/reference/operator/query/lt/#mongodb-query-op.-lt)，[`$lte`](https://www.mongodb.com/docs/upcoming/reference/operator/query/lte/#mongodb-query-op.-lte)表达式，
- [`$type`](https://www.mongodb.com/docs/upcoming/reference/operator/query/type/#mongodb-query-op.-type)表达，
- [`$and`](https://www.mongodb.com/docs/upcoming/reference/operator/query/and/#mongodb-query-op.-and)仅限顶层操作员

有关详细信息，请参阅[部分索引。](https://www.mongodb.com/docs/upcoming/core/index-partial/)

### 文档验证

从3.2开始，MongoDB提供了在更新和插入期间验证文档的功能。验证规则按每个集合指定。

要在新集合上指定文档验证，请使用[`db.createCollection()`](https://www.mongodb.com/docs/upcoming/reference/method/db.createCollection/#mongodb-method-db.createCollection)方法中的newvalidator选项。要将文档验证添加到现有集合中，请使用[`collMod`](https://www.mongodb.com/docs/upcoming/reference/command/collMod/#mongodb-dbcommand-dbcmd.collMod)命令中的新`validator`选项。有关更多信息，请参阅[架构验证。](https://www.mongodb.com/docs/upcoming/core/schema-validation/)

要查看集合的验证规范，请使用thedb[`db.getCollectionInfos()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getCollectionInfos/#mongodb-method-db.getCollectionInfos)方法。

以下命令可以使用新选项bypassDocumentValidation绕过每个操作的验证

- [`applyOps`](https://www.mongodb.com/docs/upcoming/reference/command/applyOps/#mongodb-dbcommand-dbcmd.applyOps)指挥权
- [`findAndModify`](https://www.mongodb.com/docs/upcoming/reference/command/findAndModify/#mongodb-dbcommand-dbcmd.findAndModify)command anddb[`db.collection.findAndModify()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.findAndModify/#mongodb-method-db.collection.findAndModify)方法
- [`mapReduce`](https://www.mongodb.com/docs/upcoming/reference/command/mapReduce/#mongodb-dbcommand-dbcmd.mapReduce)命令和[`db.collection.mapReduce()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.mapReduce/#mongodb-method-db.collection.mapReduce)方法
- [`insert`](https://www.mongodb.com/docs/upcoming/reference/command/insert/#mongodb-dbcommand-dbcmd.insert)指挥权
- [`update`](https://www.mongodb.com/docs/upcoming/reference/command/update/#mongodb-dbcommand-dbcmd.update)指挥权
- [`$out`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/out/#mongodb-pipeline-pipe.-out)对于[`aggregate`](https://www.mongodb.com/docs/upcoming/reference/command/aggregate/#mongodb-dbcommand-dbcmd.aggregate)命令anddb[`db.collection.aggregate()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.aggregate/#mongodb-method-db.collection.aggregate)方法

对于启用了访问控制的部署，您必须具有[`bypassDocumentValidation`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-bypassDocumentValidation)操作。内置角色[`dbAdmin`](https://www.mongodb.com/docs/upcoming/reference/built-in-roles/#mongodb-authrole-dbAdmin)和[`restore`](https://www.mongodb.com/docs/upcoming/reference/built-in-roles/#mongodb-authrole-restore)提供此操作。

### 聚合管道增强

MongoDB介绍：

- 新阶段、累加器和表达式。

- [累加器表达式的可用性](https://www.mongodb.com/docs/upcoming/release-notes/3.2/#std-label-3.2-agg-accumulator-availability)在[`$project`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project)阶段。

- [性能改进](https://www.mongodb.com/docs/upcoming/release-notes/3.2/#std-label-3.2-agg-shard-optimization)在分片集群上。

  #### 新的聚合阶段

| 舞台                                                         | 描述                             | 句法                                                         |
| :----------------------------------------------------------- | :------------------------------- | :----------------------------------------------------------- |
| [`$sample`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/sample/#mongodb-pipeline-pipe.-sample) | 从其输入中随机选择N个文档。      | `{ $sample: { size: <positive integer> } }`                  |
| [`$indexStats`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/indexStats/#mongodb-pipeline-pipe.-indexStats) | 返回有关索引使用情况的统计数据。 | `{ $indexStats: { } }`                                       |
| [`$lookup`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/lookup/#mongodb-pipeline-pipe.-lookup) | 与另一个集合执行左侧外部连接。   | {<br/>   $lookup:<br/>     {<br/>       from: <collection to join>,<br/>       localField: <fieldA>,<br/>       foreignField: <fieldB>,<br/>       as: <output array field><br/>     }<br/>} |













 Release Notes for MongoDB 3.2

 ！本页翻译征集中！

请点击页面上方 EDIT THIS PAGE 参与翻译。
详见：
[贡献指南]( https://github.com/JinMuInfo/MongoDB-Manual-zh/blob/master/CONTRIBUTING.md )、
[原文链接](  https://docs.mongodb.com/manual/release-notes/3.2/  )。

 参见

原文 - [Release Notes for MongoDB 3.2]( https://docs.mongodb.com/manual/release-notes/3.2/ )

